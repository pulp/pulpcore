# WARNING: DO NOT EDIT!
#
# This file was generated by plugin_template, and is managed by bootstrap.py. Please use
# bootstrap.py to update this file.
#
# For more info visit https://github.com/pulp/plugin_template
---
sudo: required
# https://docs.travis-ci.com/user/trusty-ci-environment/
dist: xenial
language: python
python:
  # Fedora has 3.6 available (python36.x86_64), but pulp container images
  # with it are not being built or published yet.
  # - "3.6"
  - "3.7"
env:
  matrix:
    - DB=postgres TEST=pulp
    - DB=postgres TEST=docs
    - DB=postgres TEST=bindings
matrix:
  exclude:
    - python: '3.6'
      env: DB=postgres TEST=bindings
    - python: '3.6'
      env: DB=postgres TEST=docs
  fast_finish: true
services:
  - postgresql
  - redis-server
  - docker
addons:
  apt:
    packages:
      - httpie
      - jq
  # postgres versions provided by el7 RHSCL (lowest supportable version)
  postgresql: '9.6'
before_install: .travis/before_install.sh
install: .travis/install.sh
before_script: .travis/before_script.sh
script: .travis/script.sh
after_failure:
  - http --timeout 30 --check-status --pretty format --print hb http://localhost:24817/pulp/api/v3/status/
  - sudo docker images
  - sudo kubectl logs -l name=pulp-operator -c ansible --tail=10000
  - sudo kubectl logs -l name=pulp-operator -c operator --tail=10000
  - sudo kubectl logs -l app=pulp-api --tail=50000
  - sudo kubectl logs -l app=pulp-content --tail=10000
  - sudo kubectl logs -l app=pulp-resource-manager --tail=10000
  - sudo kubectl logs -l app=pulp-worker --tail=10000
jobs:
  include:
    - stage: deploy-plugin-to-pypi
      install: skip
      script: bash .travis/publish_plugin_pypi.sh
      if: tag IS present
    - stage: publish-beta-docs
      script: bash .travis/publish_docs.sh rc
      env:
        - DB=postgres
        - TEST=docs
      if: tag IS present
    - stage: publish-continuous-docs
      script: bash .travis/publish_docs.sh nightly
      env:
        - DB=postgres
        - TEST=docs
      if: type != pull_request
    - stage: publish-daily-client-gem
      script: bash .travis/publish_client_gem.sh
      env:
        - DB=postgres
        - TEST=bindings
      if: type = cron
    - stage: publish-daily-client-pypi
      script: bash .travis/publish_client_pypi.sh
      env:
        - DB=postgres
        - TEST=bindings
      if: type = cron
    - stage: publish-client-gem
      script: bash .travis/publish_client_gem.sh
      env:
        - DB=postgres
        - TEST=bindings
      if: tag IS present
    - stage: publish-client-pypi
      script: bash .travis/publish_client_pypi.sh
      env:
        - DB=postgres
        - TEST=bindings
      if: tag IS present
notifications:
  irc:
    channels:
    - chat.freenode.net#pulp-build
    on_failure: always
    on_success: change
    template:
    - '%{repository_slug}#%{build_number} (%{branch} - %{commit} : %{author} : %{commit_subject})'
    - 'Change view : %{compare_url}'
    - 'Build details : %{build_url}'
    - '%{message}'
...
