# Troubleshoot tasks

## Debugging Tasks

In case your system gets stuck in the processing of pulp tasks, you might want to debug the tasking system.

Please always consider that your system might be in the process of dealing with long running tasks, and other tasks are rightfully waiting on their completion.

## Query tasks with the CLI

How many tasks are waiting?

```bash
pulp task list --state=waiting | jq 'length'
```

Is anybody running?

```bash
pulp task list --state=running | jq 'length'
```

How many have failed?

```bash
pulp task list --state=failed | jq 'length'
```

Retrieve the HREF's of running tasks:

```bash
pulp task list --state=running | jq 'map({.name, .pulp_href})'
# Save the HREF of the 3rd (counting starts at zero)
TASK_HREF=$(pulp task list --state=running | jq -r 'map(.pulp_href)[3]')
```

Show the state of a particular task:

```bash
pulp task show --href "$TASK_HREF"
```

Cancel a running task:

```bash
# warning canceling tasks may break higher level workflows
pulp task cancel --href "$TASK_HREF"
```

## Profiling Tasks

Task profiling is enabled by an administrator using the [TASK_DIAGNOSTICS] setting.

Users can submit a `X-TASK-DIAGNOSTICS` header with their API requests that generate tasks.
The header value should be a comma separated list of : "memory", "pyinstrument",or "memray".
For example:

```bash
`pulp --header X-TASK-DIAGNOSTICS:pyinstrument,memory rpm publication create --repository foo
````

Once the task finishes, the files generated by the profiler can be found using the following command:

```bash
pulp task profile-artifact-urls --href "$TASK_HREF"
{
  "memory_profile": "/pulp/content/default/115341ffbc5c32b379142936bd85ab658a83209a0ab03f495d0448bf1f9ffee0/0197af04-272a-71cd-b90d-174be8d8ddd8?expires=1750992034&validate_token=e56ce8188a4c16bcb36ddc916d314e623d959b3ae1ebd84a79ebafac47bc49ea:46fcedc3ca8e826fd578016cb79fa9842e472572122c312e59a6f3682d50c4aa",
  "pyinstrument_profile": "/pulp/content/default/115341ffbc5c32b379142936bd85ab658a83209a0ab03f495d0448bf1f9ffee0/0197af04-2769-78a1-9b1d-96854d8573a0?expires=1750992034&validate_token=b58aba0031f662de5666ef2bc1682093ba07d3d9cefcfbfe254ad762b34e9d0e:377c1b92d327a1432a46b64d747ecb50e830aadd79892c770e8249d087eaecdd"
}
```

The files can then be downloaded from Pulp using the paths returned by the above command.

## Tracing workloads

To help users better trace workloads in Pulp, Pulp provides support for [correlation ids].

[correlation ids]: site:pulpcore/docs/user/guides/correlation-id/
[TASK_DIAGNOSTICS]: site:pulpcore/docs/admin/reference/settings/#task_diagnostics