# WARNING: DO NOT EDIT!
#
# This file was generated by plugin_template, and is managed by it. Please use
# './plugin-template --github pulpcore' to update this file.
#
# For more info visit https://github.com/pulp/plugin_template

---
name: Create New Release Branch
on:
  workflow_dispatch:

env:
  RELEASE_WORKFLOW: true

jobs:
  create-branch:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false

    steps:
      - uses: "actions/checkout@v4"
        with:
          fetch-depth: 0
          path: "pulpcore"

      - uses: "actions/setup-python@v4"
        with:
          python-version: "3.11"

      - name: "Install python dependencies"
        run: |
          echo ::group::PYDEPS
          pip install bump2version jinja2 pyyaml packaging
          echo ::endgroup::

      - name: "Setting secrets"
        working-directory: "pulpcore"
        run: |
          python3 .github/workflows/scripts/secrets.py "$SECRETS_CONTEXT"
        env:
          SECRETS_CONTEXT: "${{ toJson(secrets) }}"

      - name: Determine new branch name
        working-directory: pulpcore
        run: |
          # Just to be sure...
          git checkout main
          NEW_BRANCH="$(bump2version --dry-run --list release | sed -Ene 's/^new_version=([[:digit:]]+\.[[:digit:]]+)\..*$/\1/p')"
          if [ -z "$NEW_BRANCH" ]
          then
            echo Could not determine the new branch name.
            exit 1
          fi
          echo "NEW_BRANCH=${NEW_BRANCH}" >> "$GITHUB_ENV"

      - name: Create release branch
        working-directory: pulpcore
        run: |
          git branch "${NEW_BRANCH}"

      - name: Bump version on main branch
        working-directory: pulpcore
        run: |
          bump2version --no-commit minor

      - name: Remove entries from CHANGES directory
        working-directory: pulpcore
        run: |
          find CHANGES -type f -regex ".*\.\(bugfix\|doc\|feature\|misc\|deprecation\|removal\)" -exec git rm {} +

      - name: Checkout plugin template
        uses: actions/checkout@v4
        with:
          repository: pulp/plugin_template
          path: plugin_template
          fetch-depth: 0

      - name: Update CI branches in template_config
        working-directory: plugin_template
        run: |
          python3 ./plugin-template pulpcore --github --latest-release-branch "${NEW_BRANCH}"
          git add -A

      - name: Make a PR with version bump and without CHANGES/*
        uses: peter-evans/create-pull-request@v6
        with:
          path: pulpcore
          token: ${{ secrets.RELEASE_TOKEN }}
          committer: pulpbot <pulp-infra@redhat.com>
          author: pulpbot <pulp-infra@redhat.com>
          branch: minor-version-bump
          base: main
          title: Bump minor version
          body: '[noissue]'
          commit-message: |
            Bump minor version
            [noissue]
          delete-branch: true

      - name: Push release branch
        working-directory: pulpcore
        run: |
          git push origin "${NEW_BRANCH}"
