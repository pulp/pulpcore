# WARNING: DO NOT EDIT!
#
# This file was generated by plugin_template, and is managed by it. Please use
# './plugin-template --github pulpcore' to update this file.
#
# For more info visit https://github.com/pulp/plugin_template

---
name: "Core changelog update"
on:
  push:
    branches:
      - "main"
    paths:
      - "CHANGES.rst"
      - "CHANGES.md"
  workflow_dispatch:

jobs:

  update-changelog:
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false

    steps:
      - uses: "actions/checkout@v4"
        with:
          fetch-depth: 1

      - uses: "actions/setup-python@v5"
        with:
          python-version: "3.11"

      - name: "Install python dependencies"
        run: |
          echo ::group::PYDEPS
          pip install -r doc_requirements.txt
          echo ::endgroup::

      - name: "Fake api schema"
        run: |
          mkdir -p docs/_build/html
          echo "{}" > docs/_build/html/api.json
          mkdir -p docs/_static
          echo "{}" > docs/_static/api.json
      - name: "Build Docs"
        run: |
          make diagrams html
        working-directory: "./docs"
        env:
          PULP_CONTENT_ORIGIN: "http://localhost/"

      - name: "Publish changlog to pulpproject.org"
        run: |
          .github/workflows/scripts/publish_docs.sh changelog ${GITHUB_REF##*/}
        env:
          PULP_DOCS_KEY: "${{ secrets.PULP_DOCS_KEY }}"
