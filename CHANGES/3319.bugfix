Hardened the state transition for tasks and ensured a canceled task will have `finished_at` set.
